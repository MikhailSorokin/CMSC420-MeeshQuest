package cmsc420.meeshquest.utilities;

import java.awt.geom.Point2D;
import java.awt.geom.Point2D.Float;
import java.util.Comparator;
import java.util.Map;
import java.util.TreeMap;

import org.w3c.dom.Element;

import cmsc420.meeshquest.citymapobjects.City;

public class MethodMediator {

	private Map<String, City> nameToCity = new TreeMap<String, City>(
			new Comparator<String>() {

				@Override
				public int compare(String name1, String name2) {
					return name2.compareTo(name1);
				}
				
			}
	);
	
	/**
	 * TODO: Make sure this implementation is correct.
	 */
	private TreeMap<Point2D.Float, City> coordinatesToCity = new TreeMap<Point2D.Float, City>(
			new Comparator<Point2D.Float>() {

				@Override
				public int compare(Float point1, Float point2) {
					int returnVal = 0;
					if (point1.getY() < point2.getY()) {
						returnVal = -1;
					} else if (point1.getY() > point2.getY()) {
						returnVal = 1;
					} else {
						if (point1.getX() < point2.getX()) {
							return -1;
						} else if (point1.getX() > point2.getX()) {
							return 1;
						} else {
							return 0;
						}
					}
				}
				
			}
	);
	
	//TODO: When successfully made a command, add a results node if there isn't one
	//in the docs already. Else, add a failNode
	//TODO: Make this function create xml elements when needed
	private void CreateXmlElement() {
		//results.createElement("")
	}
	
	private void CreateCityErrorOutput(String name, int x, int y, int radius, String color) {
		Element errorElement = XmlParser.results.createElement("error");
		XmlParser.currElement.appendChild(errorElement);
		
		Element commandElement = XmlParser.results.createElement("command");
		commandElement.setAttribute("name", "createCity");
		errorElement.appendChild(commandElement);
		
		Element parametersElement = XmlParser.results.createElement("parameters");
		errorElement.appendChild(parametersElement);
		
		Element nameElement = XmlParser.results.createElement("name");
		nameElement.setAttribute("value", name);
		parametersElement.appendChild(nameElement);
		
		Element xCoordElement = XmlParser.results.createElement("x");
		xCoordElement.setAttribute("value", Integer.toString(x));
		parametersElement.appendChild(xCoordElement);
		
		Element yCoordElement = XmlParser.results.createElement("y");
		yCoordElement.setAttribute("value", Integer.toString(y));
		parametersElement.appendChild(yCoordElement);
		
		Element radiusElement = XmlParser.results.createElement("radius");
		radiusElement.setAttribute("value", Integer.toString(radius));
		parametersElement.appendChild(radiusElement);
		
		Element colorElement = XmlParser.results.createElement("color");
		colorElement.setAttribute("value", color);
		parametersElement.appendChild(colorElement);
	}
	
	/**
	 * Creates a city based on the parameters, which are given by the 
	 * @param name
	 * @param x
	 * @param y
	 * @param radius
	 * @param color
	 */
	public void CreateCity(String name, int x, int y, int radius, String color) {
		City city = new City(name, x, y, radius, color);
		if (!nameToCity.containsKey(name)) {
			nameToCity.put(name, city);
		} else {
			CreateCityErrorOutput(name, x, y, radius, color);
			return;
		}
		
		if(!coordinatesToCity.containsKey(new Point2D.Float(x, y))) {
			coordinatesToCity.put(city.getCoordinates(), city);
		} else {
			CreateCityErrorOutput(name, x, y, radius, color);
			return;
		}
		
		Element successElement = XmlParser.results.createElement("success");
		XmlParser.currElement.appendChild(successElement);
		
		Element commandElement = XmlParser.results.createElement("command");
		commandElement.setAttribute("name", "createCity");
		successElement.appendChild(commandElement);
		
		Element parametersElement = XmlParser.results.createElement("parameters");
		successElement.appendChild(parametersElement);
		
		Element nameElement = XmlParser.results.createElement("name");
		nameElement.setAttribute("value", name);
		parametersElement.appendChild(nameElement);
		
		Element xCoordElement = XmlParser.results.createElement("x");
		xCoordElement.setAttribute("value", Integer.toString(x));
		parametersElement.appendChild(xCoordElement);
		
		Element yCoordElement = XmlParser.results.createElement("y");
		yCoordElement.setAttribute("value", Integer.toString(y));
		parametersElement.appendChild(yCoordElement);
		
		Element radiusElement = XmlParser.results.createElement("radius");
		radiusElement.setAttribute("value", Integer.toString(radius));
		parametersElement.appendChild(radiusElement);
		
		Element colorElement = XmlParser.results.createElement("color");
		colorElement.setAttribute("value", color);
		parametersElement.appendChild(colorElement);
		
		Element outputElement = XmlParser.results.createElement("output");
		successElement.appendChild(outputElement);
		
	}
	
	/**
	 * A method to sort all of the cities in order. One can specify
	 * how they would like to sort the elements.
	 * @param sortMethod
	 */
	public void ListCities(String sortMethod) {
		
		if (nameToCity.size() >= 1) {
		
			Element successElement = XmlParser.results.createElement("success");
			XmlParser.currElement.appendChild(successElement);
			
			Element commandElement = XmlParser.results.createElement("command");
			commandElement.setAttribute("name", "listCities");
			successElement.appendChild(commandElement);
			
			Element parametersElement = XmlParser.results.createElement("parameters");
			successElement.appendChild(parametersElement);
			
	
			Element sortByElement = XmlParser.results.createElement("sortBy");
			
			if (sortMethod.equals("name")) {
				sortByElement.setAttribute("value", "name");
				parametersElement.appendChild(sortByElement);
				
				Element outputElement = XmlParser.results.createElement("output");
				successElement.appendChild(outputElement);
				
				Element cityListElement = XmlParser.results.createElement("cityList");
				outputElement.appendChild(cityListElement);
	
				for (String entry : nameToCity.keySet()) { 
					City cityFromKey = nameToCity.get(entry);
	
					Element cityElement = XmlParser.results.createElement("city");
					cityElement.setAttribute("color", cityFromKey.getColor());
					cityElement.setAttribute("name", cityFromKey.getName());
					cityElement.setAttribute("radius", Integer.toString(cityFromKey.getRadius()));
					cityElement.setAttribute("x", Integer.toString((int)cityFromKey.getX()));
					cityElement.setAttribute("y", Integer.toString((int)cityFromKey.getY()));
					
					cityListElement.appendChild(cityElement);
				}
				
			} else if (sortMethod.equals("coordinate")) {
				sortByElement.setAttribute("value", "coordinate");
				parametersElement.appendChild(sortByElement);
				
				Element outputElement = XmlParser.results.createElement("output");
				successElement.appendChild(outputElement);
				
				Element cityListElement = XmlParser.results.createElement("cityList");
				outputElement.appendChild(cityListElement);
	
				for (String entry : nameToCity.keySet()) { 
					City cityFromKey = nameToCity.get(entry);
	
					Element cityElement = XmlParser.results.createElement("city");
					cityElement.setAttribute("color", cityFromKey.getColor());
					cityElement.setAttribute("name", cityFromKey.getName());
					cityElement.setAttribute("radius", Integer.toString(cityFromKey.getRadius()));
					cityElement.setAttribute("x", Integer.toString((int)cityFromKey.getX()));
					cityElement.setAttribute("y", Integer.toString((int)cityFromKey.getY()));
					
					cityListElement.appendChild(cityElement);
				}
			}
		} else {
			//TODO: Handle FATAL error here!
		}
	}
	
}
